{% extends "base.html" %}
{% block title %}Delete Participant{% endblock %}

{% block extra_head %}
<!------------------------------------------------ CSS -------------------------------------------------->
<style>
  /* Layout */
  .search-wrap { position: relative; max-width: 720px; }

  /* Input */
  #participantSearch {
    font-size: 1.25rem;              /* bigger input text */
    padding: .75rem 1rem;
  }

  /* Dropdown panel */
  .results {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    z-index: 1000;
    background: #fff;
    border: 1px solid #dee2e6;
    border-top: none;
    border-radius: 0 0 .5rem .5rem;
    box-shadow: 0 .25rem .75rem rgba(0,0,0,.08);
    max-height: 320px;
    overflow-y: auto;
    display: none;                   /* hidden by default */
  }

  /* One result row */
  .result-item {
    padding: .6rem .9rem;
    cursor: pointer;
    border-top: 1px solid #f2f2f2;
  }
  .result-item:first-child { border-top: none; }

  /* Typography inside each row */
  .result-name {
    font-size: 1.1rem;              /* bigger name */
    font-weight: 600;
    line-height: 1.2;
  }
  .result-pps {
    font-size: .95rem;
    color: #6c757d;
  }

  /* Hover / active (keyboard) */
  .result-item:hover,
  .result-item.active {
    background: #e9f2ff;
  }

  /* No results row */
  .no-results {
    padding: .75rem .9rem;
    color: #6c757d;
    font-style: italic;
  }

  /* Highlighted match text */
  .hl { background: #fff3cd; border-radius: .25rem; }
</style>
{% endblock %}



<!------------------------------------------------ HTML -------------------------------------------------->
{% block content %}
<div class="text-center mb-4">
  <h2>Delete Participant</h2>
</div>

<form id="delete-form" method="POST" action="" class="mx-auto" style="max-width: 720px;">
  {% csrf_token %}


  <div class="search-wrap">
    <input
      id="participantSearch"
      class="form-control"
      type="text"
      placeholder="Start typing nameâ€¦"
      autocomplete="off"
      aria-autocomplete="list"
      aria-controls="participantResults"
      aria-expanded="false"
      role="combobox"
    >
    <div id="participantResults" class="results" role="listbox" aria-label="Participants"></div>
  </div>

  <!-- Hidden field your server uses -->
  <input type="hidden" name="participant_id" id="participant_id">

  <button type="submit" class="btn btn-danger mt-3">Delete</button>
</form>
{% endblock %}



<!--------------------------------------------- JAVASCRIPT ----------------------------------------------->
{% block extra_js %}
<script>
  (function () {
    // ---- Data: render from Django into a lightweight JS array ----
    const participants = [
      {% for p in participants %}
        {
          id: "{{ p.id }}",
          name: "{{ p.first_name|escapejs }} {{ p.last_name|escapejs }}",
          pps: "{{ p.ppsn|default:''|escapejs }}"
        }{% if not forloop.last %},{% endif %}
      {% endfor %}
    ];

    // ---- Elements ----
    const input   = document.getElementById('participantSearch');
    const list    = document.getElementById('participantResults');
    const hidden  = document.getElementById('participant_id');
    const form    = document.getElementById('delete-form');

    let activeIndex = -1;          // keyboard focus index
    let currentItems = [];         // items currently shown

    // ---- Utilities ----
    function normalize(s) { return (s || '').toLowerCase().trim(); }

    function highlight(text, term) {
      if (!term) return text;
      const esc = term.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      return text.replace(new RegExp(esc, 'ig'), m => `<span class="hl">${m}</span>`);
    }


    function render(items) {
  list.innerHTML = '';
  activeIndex = -1;
  currentItems = items;

  if (!items.length) {
    list.innerHTML = `<div class="no-results">No matches</div>`;
    showList(true);
    return;
  }

  const frag = document.createDocumentFragment();
  items.forEach((p, i) => {
    const el = document.createElement('div');
    el.className = 'result-item';
    el.setAttribute('role', 'option');
    el.setAttribute('data-index', i);
    el.setAttribute('data-id', p.id);

    el.innerHTML = `
      <div class="result-name">${p.name}</div>
      <div class="result-pps">(PPS: ${p.pps || 'N/A'})</div>
    `;

    // click select
    el.addEventListener('mousedown', function(e){
      e.preventDefault();
      choose(i);
    });
    frag.appendChild(el);
  });
  list.appendChild(frag);
  showList(true);
}




    function showList(show) {
      list.style.display = show ? 'block' : 'none';
      input.setAttribute('aria-expanded', show ? 'true' : 'false');
    }

    function filter(term) {
      const t = normalize(term);
      if (!t) {
        showList(false);
        return;
      }
      const items = participants.filter(p => {
        return normalize(p.name).includes(t) || normalize(p.pps).includes(t);
      }).slice(0, 50); // cap results
      render(items, t);
    }

    function setActive(i) {
      const rows = list.querySelectorAll('.result-item');
      rows.forEach(r => r.classList.remove('active'));
      if (i >= 0 && i < rows.length) {
        rows[i].classList.add('active');
        activeIndex = i;
        rows[i].scrollIntoView({ block: 'nearest' });
      }
    }

    function choose(i) {
      const item = currentItems[i];
      if (!item) return;
      input.value = `${item.name} (PPS: ${item.pps || 'N/A'})`;
      hidden.value = item.id;
      showList(false);
    }

    function clearSelection() {
      hidden.value = '';
    }

    // ---- Events ----
    input.addEventListener('input', function () {
      clearSelection();
      filter(this.value);
    });

    input.addEventListener('focus', function () {
      if (this.value) filter(this.value);
    });

    input.addEventListener('blur', function () {
      // Close after short delay to allow click
      setTimeout(() => showList(false), 120);
    });

    input.addEventListener('keydown', function (e) {
      const rows = list.querySelectorAll('.result-item');
      if (!rows.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        setActive(Math.min(activeIndex + 1, rows.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        setActive(Math.max(activeIndex - 1, 0));
      } else if (e.key === 'Enter') {
        if (activeIndex >= 0) {
          e.preventDefault();
          choose(activeIndex);
        }
      } else if (e.key === 'Escape') {
        showList(false);
      }
    });

    // ---- Submit guard + confirm ----
    form.addEventListener('submit', function (e) {
      if (!hidden.value) {
        e.preventDefault();
        alert('Please choose a participant from the list.');
        input.focus();
        return;
      }
      const label = input.value || 'this participant';
      if (!confirm(`Delete ${label}? This cannot be undone.`)) {
        e.preventDefault();
      }
    });
  })();
</script>
{% endblock %}
